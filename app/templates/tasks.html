{% extends 'base.html' %}
{% block content %}
{% include 'menu.html' %}
<div class="container-fluid white">
    <h2>Tasks</h2>

    <div class="row-fluid well transparent white">
        <div id="row-button-cve" hidden>
            <span><a id="getcve-async" class="btn btn-primary">
                Update CVE
            </a></span>
            <span class="pull-right">The CVE Update is executed once per day at midnight. Click the above button to update the CVE right now.</span>
        </div>
        <div id="row-progress-cve" hidden>
            <div class="progress">
                <div id="progress-cve-percentage" class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0"
                     aria-valuemax="100" style="width: 0%; min-width: 2em;">
                    0%
                </div>
            </div>
            <span id="progress-cve-message"></span>
        </div>
        <br/>

        <div id="row-button-scan" hidden>
            <span><a id="scan-async" class="btn btn-primary">Fetch Configurations</a></span>
            <span class="pull-right">Click here to fetch the configurations of your devices.</span>
        </div>
        <div id="row-progress-scan" hidden>
            <div class="progress">
                <div id="progress-scan" class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0"
                     aria-valuemax="100" style="width: 0%; min-width: 2em;">
                    0%
                </div>
            </div>
            <span id="progress-message-scan"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js_at_end %}
<script>
    function start_long_task(url, status_url, percentage_div, message_div) {
        $.ajax({
            type: 'POST',
            url: url,
            success: function(data, status, request) {
                update_progress(status_url, percentage_div, message_div);
            },
            error: function() {
                alert('Unexpected error');
            }
        });
    }

    function update_progress(status_url, percentage_div, message_div) {
        $.getJSON(status_url, function(data) {
            if(data['status'] == 'PENDING') {
                percentage_div.css('width 0%').attr('aria-valuenow', 0).text("0%");
                message_div.text(percent + "% " + data['message']);
            } else {
                percent = parseInt(data['percentage']);
                percentage_div.css('width', percent + '%').attr('aria-valuenow', percent).text(percent + "%");
                message_div.text(percent + "% " + data['message']);
                if (percent != 100) {
                    setTimeout(function() {
                        update_progress(status_url, percentage_div, message_div);
                    }, 1000);
                }
            }
        });
    }

    var initial_data = null;
    $.ajax({
        url: "{{ url_for('async_cve_update_status') }}"
    }).done(function (data) {
        initial_data = data;
        if (initial_data.started) {
            $("#row-progress-cve").show();
            update_progress(
                "{{ url_for('async_cve_update_status') }}",
                $("#progress-cve-percentage"),
                $("#progress-cve-message")
            );
        } else {
            $("#row-button-cve").show();
        }
    });
    $("#getcve-async").click(function() {
        $("#row-progress-cve").show();
        $("#row-button-cve").hide();
        start_long_task(
            "{{ url_for('async_cve_update') }}",
            "{{ url_for('async_cve_update_status') }}",
            $("#progress-cve-percentage"),
            $("#progress-cve-message")
        );
    });

    $("#row-button-scan").show();
    $("#scan-async").click(function() {
        start_long_task("{{ url_for('start_scan_all_devices_async') }}");
    });




</script>
{% endblock %}
